# 小说RAG系统使用说明

## 快速开始

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

**注意**: 向量化使用千帆 API，无需下载本地 embedding 模型；首次运行需配置 `BAIDU_API_KEY`。

### 2. 启动API服务

**Windows用户**:
```bash
run_api.bat
```

**Linux/Mac用户**:
```bash
python api.py
```

服务启动后,访问 `http://localhost:8000/docs` 打开Swagger UI界面。

### 3. 使用Web界面

**启动Web聊天界面**:
```bash
python web_chat.py
```

然后在浏览器中访问 `http://localhost:8000` 进行测试。

## 核心功能说明

### 1. 智能分块策略

- **分别处理**: 《雪落成诗》和《影化成殇》分别建立索引,不合并
- **按章节分割**: 首先按章节标题分割,保持上下文完整性
- **重叠窗口**: 使用重叠窗口,确保语义连续性
- **人名保护**: 自动将人物名称加入jieba用户词典,确保人名不被切分在块边缘
- **分块大小**: 默认500字符,可根据需要调整

### 2. 三重索引架构

系统采用三层索引协同工作:
- **语义向量层**: 使用ChromaDB存储高维向量(2560维),支持语义相似度搜索
- **关键词索引层**: 使用BM25算法进行关键词匹配,补充语义检索
- **摘要/主题层**: 全局摘要、时间线、意象系统等结构化知识

### 3. 混合检索机制

- **并行检索**: RAG文档检索和人物画像检索并行执行,提高效率
- **混合评分**: 结合语义相似度和关键词匹配分数,综合排序
- **人物识别**: 自动识别查询中涉及的人物,检索相关画像信息
- **结果融合**: 将人物画像信息与文档片段合并,提供更丰富的上下文

### 4. 背景信息结合

当用户查询《影化成殇》相关内容时:
- 系统自动从《影化成殇》中检索直接相关的内容
- 同时从《雪落成诗》中检索背景信息
- **重要**: 只输出《影化成殇》中直接提及的内容
- 背景信息作为补充说明,明确标注来源

### 5. 多跳推理模块

系统集成了ReasoningModule,支持复杂问题的多跳推理:
- **功能**: 判断是否需要二次检索,生成链式查询意图
- **适用场景**: 需要多步骤推理的复杂问题
- **技术**: 使用DeepSeek Reasoner进行推理判断
- **自动启用**: 对于行为分析类问题,系统会自动判断是否需要多跳检索

### 6. 结构化查询引擎

系统使用StructuredQueryEngine优化知识库查询:
- **功能**: 根据查询词精准提取JSON知识库相关字段,避免全文传递
- **优势**: 减少token消耗,提高查询效率
- **支持**: 时间线、心理学概念库、意象系统、元文本知识库等结构化数据
- **自动使用**: 行为分析模块自动调用结构化查询引擎

### 7. 行为分析模块

系统提供统一行为分析模块,支持两类问题:

#### 7.1 行为解释类问题
- **识别**: 询问人物行为解释、心理动机、行为模式等问题
- **示例**: "为什么雪遗诗会这样做"、"夏空山的行为动机是什么"、"这种行为模式的心理原因"
- **数据源**: 
  - 人物画像库(人物.json)
  - 时间线索引(时间线梳理.txt)
  - 元文本知识库(元文本知识库.json)
  - 意象系统(意象系统.txt)
  - **心理学概念库**(小说心理学概念库.json)
- **分析框架**: 基于人物心理模型、时间线信息和心理学概念,深入分析行为动机和心理机制

#### 7.2 情节推演类问题
- **识别**: 询问假设性情节推演、如果...会怎样等问题
- **示例**: "如果雪遗诗没有表白会怎样"、"假设夏空山没有发绝交短信"、"要是他们在一起了会怎样"
- **数据源**: 
  - 人物画像库(人物.json)
  - 时间线索引(时间线梳理.txt)
  - 元文本知识库(元文本知识库.json)
  - 意象系统(意象系统.txt)
  - **情节推演规则**(情节推演规则.json)
- **分析框架**: 基于人物心理模型、时间线信息和情节推演规则,推演假设性情节的可能发展

#### 7.3 模块特点
- **统一接口**: 两类问题都走同一个行为分析模块
- **智能路由**: LLM自动判断问题类型,调用相应的知识库
- **数据整合**: 自动整合多个数据源,构建完整的分析框架
- **专业分析**: 行为解释类使用心理学理论,情节推演类遵循推演规则

### 8. 检索性能

- **目标**: 检索时间 < 10秒
- **优化**: 
  - 使用ChromaDB持久化向量数据库
  - 一次性向量化,后续检索本地运行
  - 向量化使用百度千帆 API（Qwen3-Embedding-8B），无本地 GPU 需求
  - 内存优化: 千帆 API 批处理控制

## API接口使用

### 回答问题 (`POST /api/answer`)

**请求示例**:
```json
{
  "question": "您的问题",
  "target_source": null,
  "use_background": true,
  "top_k": 5
}
```

**响应示例**:
```json
{
  "question": "您的问题",
  "answer": "根据文档检索到的答案...",
  "sources": [
    {
      "source": "雪落成诗",
      "chapter": "章节名称",
      "content": "相关文档片段..."
    }
  ],
  "target_source": "雪落成诗"
}
```

### 检索文档 (`POST /api/search`)

用于获取相关文档片段,不生成答案。

### 重建索引 (`POST /api/rebuild_index`)

重新构建向量索引(谨慎使用,耗时较长)。

## 技术细节

### Embedding（千帆 API）

本上线版本**仅使用百度千帆 API**（Qwen3-Embedding-8B）做向量化，无本地 embedding 或 GPU 需求。在 `.env` 或 `SUPER_MIND_API_KEY.env` 中配置 `BAIDU_API_KEY` 即可。

### 向量数据库

使用 ChromaDB:
- 持久化存储,索引保存在 `./chroma_db` 目录
- 支持相似度搜索
- 自动管理索引
- 向量维度由千帆模型决定（Qwen3-Embedding-8B）

### 关键词检索

使用 BM25 + Jieba:
- **BM25算法**: 用于关键词匹配和评分
- **Jieba分词**: 中文文本分词,自动加载人物名称到用户词典
- **混合检索**: BM25和语义向量检索结果融合排序

### 人物系统

- **数据源**: `数据源/人物.json`
- **自动加载**: 系统启动时自动加载人物画像
- **分词集成**: 人物名称和别名自动加入jieba用户词典
- **并行检索**: 与RAG文档检索并行执行,提高响应速度

### 行为分析知识库

系统集成了多个知识库用于行为分析:

- **人物画像库** (`数据源/人物.json`): 包含人物心理模型、行为模式、关键事件等
- **时间线索引** (`数据源/时间线梳理.txt`): 提供事件时间顺序和发展脉络
- **元文本知识库** (`数据源/元文本知识库.json`): 提供创作背景和元文本信息
- **意象系统** (`数据源/意象系统.txt`): 提供意象、象征、隐喻等信息
- **心理学概念库** (`数据源/小说心理学概念库.json`): 用于行为解释类问题,包含性欲化防御、创伤联结、强迫性重复等心理学概念
- **情节推演规则** (`数据源/情节推演规则.json`): 用于情节推演类问题,包含人物一致性规则、因果关系规则、环境约束规则等

### 分块参数

- `chunk_size`: 默认500字符,可根据文档特点调整
- `chunk_overlap`: 默认100字符,保持上下文连续性
- 可在初始化时自定义:
  ```python
  rag = NovelRAGSystem(chunk_size=800, chunk_overlap=150)
  ```

## 常见问题

### Q1: 首次运行很慢?

A: 首次运行需要:
1. 配置 `BAIDU_API_KEY`（千帆 API），无需下载本地模型
2. 构建向量索引（调用千帆 API 向量化，可能需要几分钟，取决于文档量与网络）
后续运行会直接使用已构建的索引

### Q2: 如何重建索引?

A: 通过API调用:
```bash
POST /api/rebuild_index
```

或在代码中:
```python
rag_system.build_index(force_rebuild=True)
```

### Q3: 检索结果不准确?

A: 可以尝试:
1. 调整 `top_k` 参数,增加检索数量
2. 使用更具体的问题描述
3. 明确指定 `target_source`

### Q4: 如何修改分块大小?

A: 在初始化时指定:
```python
rag = NovelRAGSystem(chunk_size=800, chunk_overlap=150)
```

然后重建索引。

### Q5: 如何更新人物系统?

A: 修改 `数据源/人物.json` 文件后:
1. 重启程序,系统会自动重新加载人物数据
2. 人物名称会自动更新到jieba分词词典
3. 无需重建向量索引(人物系统独立于文档索引)

### Q6: 行为分析模块如何使用?

A: 行为分析模块会自动识别两类问题:
1. **行为解释类**: 询问"为什么"、"行为动机"、"心理原因"等问题,系统会自动调用心理学概念库进行分析
2. **情节推演类**: 询问"如果...会怎样"、"假设"、"要是"等问题,系统会自动调用情节推演规则进行推演

无需手动指定,系统会根据问题内容自动判断类型并调用相应的知识库。

### Q7: 如何更新行为分析知识库?

A: 修改相应的知识库文件后:
1. **人物画像库**: 修改 `数据源/人物.json`,重启程序即可
2. **时间线索引**: 修改 `数据源/时间线梳理.txt`,重启程序即可
3. **心理学概念库**: 修改 `数据源/小说心理学概念库.json`,重启程序即可
4. **情节推演规则**: 修改 `数据源/情节推演规则.json`,重启程序即可

所有知识库文件修改后只需重启程序,无需重建向量索引。

### Q8: 多跳推理模块如何使用?

A: 多跳推理模块会自动工作:
1. **自动判断**: 对于复杂问题,系统会自动判断是否需要多跳检索
2. **二次检索**: 如果需要,ReasoningModule会生成链式查询意图,进行二次检索
3. **无需配置**: 模块已集成到系统中,无需额外配置
4. **适用场景**: 特别适用于需要多步骤推理的行为分析类问题

### Q9: 结构化查询引擎的作用是什么?

A: 结构化查询引擎用于优化知识库查询:
1. **精准提取**: 根据查询词精准提取JSON知识库中的相关字段
2. **减少消耗**: 避免全文传递整个知识库,减少token消耗
3. **提高效率**: 只传递相关数据,提高查询和生成效率
4. **自动使用**: 行为分析模块会自动调用结构化查询引擎

## 性能指标

- **索引构建时间**: 取决于文档量与千帆 API 调用，通常数分钟
- **单次检索时间**: < 10秒(目标,通常1-5秒)
- **内存占用**: 无本地大模型，主要为 Chroma/BM25 与 FastAPI 进程

## 公网部署与密钥

- 若仓库公开部署，**不要**将 `.env`、`数据源/`、`chroma_db/` 提交到 Git；密钥通过部署平台环境变量注入，数据源通过挂载或 Secret 提供。
- 详见 [部署与密钥说明](docs/部署与密钥说明.md)。

## 注意事项

1. **数据源位置**: 确保 `数据源` 文件夹下有正确的 txt 文件和人物.json 文件（或通过环境变量 `DATA_SOURCE_DIR` 指定目录）
2. **编码格式**: 文件必须使用UTF-8编码
3. **索引存储**: 索引存储在 `./chroma_db` 目录,删除后需要重建
4. **向量化**: 仅使用千帆 API，需配置 `BAIDU_API_KEY`；无本地模型或 GPU 要求

## 开发说明

### 项目结构

```
.
├── 数据源/                          # 数据源目录
│   ├── 雪落成诗 - 松筠长青.txt      # 主文档
│   ├── 影化成殇 - 松筠长青.txt      # 续集文档
│   ├── 人物.json                    # 人物画像系统
│   ├── 元文本知识库.json            # 元文本分析知识库
│   ├── 全局摘要.txt                 # 全局摘要数据
│   ├── 时间线梳理.txt               # 时间线数据
│   ├── 意象系统.txt                 # 意象系统数据
│   ├── 章节摘要.txt                 # 章节摘要数据
│   ├── 章节映射.json                # 章节编号到章节名称的映射表
│   ├── 小说心理学概念库.json        # 心理学概念库(用于行为解释类)
│   └── 情节推演规则.json            # 情节推演规则(用于情节推演类)
├── rag_modules/                     # RAG检索模块
│   ├── base_retriever.py           # 基础检索器
│   ├── global_summary_retriever.py # 全局摘要检索器
│   ├── timeline_retriever.py       # 时间线检索器
│   ├── character_arc_retriever.py  # 人物关系检索器
│   ├── imagery_retriever.py        # 意象检索器
│   ├── meta_knowledge_retriever.py  # 元文本知识检索器
│   ├── chapter_rag_retriever.py    # 章节RAG检索器
│   ├── chapter_summary_retriever.py # 章节摘要检索器
│   ├── dynamic_summary_generator.py # 动态摘要生成器
│   ├── behavior_analyzer.py        # 统一行为分析模块
│   ├── reasoning_module.py         # 多跳推理模块
│   └── structured_query_engine.py  # 结构化查询引擎
├── chroma_db/                      # ChromaDB向量数据库(自动生成)
├── rag_system.py                   # RAG系统核心模块
├── llm_rag_system.py              # LLM+RAG智能系统
├── web_chat.py                     # Web聊天界面
├── api.py                          # FastAPI接口(备用)
├── rebuild_index.py                # 索引重建脚本
├── requirements.txt                # 依赖列表
├── README.md                       # 项目说明
└── 使用说明.md                     # 本文件
```

### 扩展开发

如需扩展功能,可以:
1. 修改 `rag_system.py` 中的检索逻辑
2. 在 `web_chat.py` 或 `api.py` 中添加新的接口
3. 在 `rag_modules/` 中添加新的检索器模块
4. 调整分块策略以适应不同文档类型
5. 在 `behavior_analyzer.py` 中扩展行为分析功能
6. 添加新的知识库文件到 `数据源/` 目录

### 动态摘要功能

动态摘要功能用于处理复杂问题，需要跨章节综合分析。**默认已启用**，程序会自动判断是否为复杂问题并决定是否使用动态摘要。

**禁用方法**（如需对比测试）：

```bash
# Windows (PowerShell)
$env:ENABLE_DYNAMIC_SUMMARY="false"

# Windows (CMD)
set ENABLE_DYNAMIC_SUMMARY=false

# Linux/Mac
export ENABLE_DYNAMIC_SUMMARY=false
```

测试问题请参考 `动态摘要测试问题.md` 文件。
