# 部署与密钥说明（公网 / GitHub 开放仓库）

本文说明在**公开 GitHub 仓库**下如何安全地部署本 RAG 项目到公网（如 ai-builders.space），以及数据源与密钥如何以 Secret 形式管理。

## 一、仓库里不提交什么 / 可以提交什么

**不提交（已加入 `.gitignore`）：**

| 类型 | 路径/文件 | 说明 |
|------|-----------|------|
| 密钥 | `.env`、`SUPER_MIND_API_KEY.env` | API Key 等，仅本地或部署平台 env_vars |
| 数据源目录 | `数据源/` | 原始明文目录，不提交；使用打包文件见下 |

**可以提交（随仓库部署使用）：**

| 类型 | 路径/文件 | 说明 |
|------|-----------|------|
| 数据源打包 | `数据源.pack.zip` | 由维护者本地打包（**仅含运行时必需文件，不含两本小说原文**），zip 二进制；clone 后启动时自动解压使用；clone 者无原文无法重建索引 |
| 索引 | `chroma_db/` | 由维护者本地运行 `rebuild_index.py` 构建后提交；部署时直接使用，无需重建 |

**不提交（仅维护者本地保留）：**

| 类型 | 路径/文件 | 说明 |
|------|-----------|------|
| 重建索引脚本 | `rebuild_index.py` | 已加入 `.gitignore`；clone 者缺原文无法重建索引，故不放入仓库 |

请务必**不要**把密钥或明文 `数据源/` 目录提交到 Git。

## 二、部署前你需要准备的内容

### 1. 密钥类（通过平台环境变量注入）

部署时在平台（如 ai-builders.space 的 `env_vars`）中配置，不要写进代码或仓库：

- **DEEPSEEK_API_KEY** 或 **OPENAI_API_KEY**：LLM 调用
- **BAIDU_API_KEY**：千帆 Embedding（本上线版本仅使用千帆 API，无本地 embedding）
- 可选：**OPENAI_API_BASE**、**CORS_ORIGINS** 等

参考项目根目录的 `.env.example`，只做占位说明，不包含真实密钥。

### 2. 数据源与 chroma_db（本仓库方案）

- **数据源**：不提交明文 `数据源/`。维护者本地打包生成 **`数据源.pack.zip`**，仅含运行时必需文件（人物、元文本、时间线等），**不含两本小说原文**，提交该 zip；clone 者无原文无法重建索引。应用启动时自动解压使用（见 `data_source_loader.py`）。
- **chroma_db**：维护者本地保留完整 `数据源/`（含原文）和 **`rebuild_index.py`**，运行 `python rebuild_index.py` 构建后，将 **`chroma_db/`** 提交；**`rebuild_index.py`** 不提交（已加入 .gitignore）。部署时 clone 即带 chroma_db 与 数据源.pack.zip，无需重建。
- 若希望数据源/索引完全私有，再考虑平台挂载或 env 注入（见 [env_vars与数据源配置说明](env_vars与数据源配置说明.md)）。

### 3. 环境变量汇总（部署时）

| 变量名 | 必填 | 说明 |
|--------|------|------|
| DEEPSEEK_API_KEY 或 OPENAI_API_KEY | 是 | LLM API Key |
| BAIDU_API_KEY | 是 | 千帆 Embedding API Key（本版本仅千帆，无本地 embedding） |
| DATA_SOURCE_DIR | 按需 | 数据源目录路径，不设则用默认 `数据源` |
| CHROMA_DB_PATH | 按需 | Chroma 与 BM25 缓存目录，不设则用 `./chroma_db` |
| PORT | 否 | 由平台（如 Koyeb）注入，应用已支持 |
| CORS_ORIGINS | 按需 | 前端域名，逗号分隔 |

## 三、部署流程简要

1. **确认公开仓库**：代码、Dockerfile、.env.example、**数据源.pack.zip**、**chroma_db/** 已提交并推送；**不要**提交 `.env`、明文 `数据源/` 目录。
2. **在平台创建/配置服务**：填写 GitHub 仓库 URL、分支、服务名；在 `env_vars` 中填入 DEEPSEEK_API_KEY、BAIDU_API_KEY 等。
3. **构建与启动**：平台 clone 仓库（含 数据源.pack.zip、chroma_db），按 Dockerfile 构建镜像；启动时应用会自动解压 数据源.pack.zip 并使用 chroma_db，无需挂载。

## 四、同步到 GitHub（chroma_db 与 数据源.pack.zip，仅维护者）

**维护者**在本地完成以下步骤后 `git push`；**clone 者**只有 chroma_db + 数据源.pack.zip（无原文、无 rebuild_index.py），只能运行应用，不能重建索引。

1. **打包数据源（仅运行时必需，不含小说原文）**  
   由维护者本地将 `数据源/` 目录打包为 **`数据源.pack.zip`**（不含 雪落成诗/影化成殇 原文，可提交）。

2. **重建索引（仅维护者本地，需完整 数据源/ 含原文）**  
   ```bash
   python rebuild_index.py
   ```
   会生成 **`chroma_db/`**。`rebuild_index.py` 已加入 .gitignore，不提交。

3. **提交并推送**  
   ```bash
   git add chroma_db 数据源.pack.zip
   git status   # 确认没有 数据源/、.env、rebuild_index.py 等
   git commit -m "添加 chroma_db 与 数据源.pack.zip 供部署使用"
   git push
   ```

若你之前已把 `rebuild_index.py` 提交过，要从仓库移除但保留本地：  
`git rm --cached rebuild_index.py` 后 commit、push。

## 五、本地开发与首次运行

- 复制 `.env.example` 为 `.env` 或 `SUPER_MIND_API_KEY.env`，填入真实密钥（勿提交）。
- 在项目根目录放置 **`数据源/`** 或 **`数据源.pack.zip`**；运行 `python web_chat.py` 或 `python api.py` 时，若无 数据源/ 会从 数据源.pack.zip 解压使用；若无索引可执行 `python rebuild_index.py`。

## 六、人工检查清单（部署前请你自行确认）

- [ ] 未将 `.env`、`SUPER_MIND_API_KEY.env`、明文 `数据源/` 目录提交到 GitHub。
- [ ] 已提交 **数据源.pack.zip**、**chroma_db/**（按「四、同步到 GitHub」步骤生成并 add）。
- [ ] 已在部署平台的 `env_vars` 中配置 DEEPSEEK_API_KEY（或 OPENAI_API_KEY）、BAIDU_API_KEY。
- [ ] 所有改动已 `git add`、`git commit`、`git push` 到要部署的分支。
- [ ] 如需 CORS：已设置 CORS_ORIGINS 为前端域名（逗号分隔）。
